<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Split the Tab - Debug</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #1a1a2e;
            color: white;
        }
        .debug-section {
            background: #2a2a3e;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #64ffda;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background: #2e7d32; }
        .error { background: #d32f2f; }
        .warning { background: #f57c00; }
        .info { background: #1976d2; }
        button {
            background: #64ffda;
            color: #1a1a2e;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #4fd3b8;
        }
        pre {
            background: #000;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>ðŸ”§ Split the Tab - Debug Console</h1>
    
    <div class="debug-section">
        <h2>Firebase Connection Test</h2>
        <div id="firebaseStatus">Checking Firebase connection...</div>
        <button onclick="testFirebaseConnection()">Test Firebase</button>
        <button onclick="testFirestore()">Test Firestore</button>
        <button onclick="testAuth()">Test Auth</button>
    </div>

    <div class="debug-section">
        <h2>User Authentication</h2>
        <div id="authStatus">Not authenticated</div>
        <button onclick="signInAnonymously()">Sign In Anonymously</button>
        <button onclick="signOut()">Sign Out</button>
    </div>

    <div class="debug-section">
        <h2>Database Operations</h2>
        <div id="dbStatus">Ready to test</div>
        <button onclick="testCreateGroup()">Test Create Group</button>
        <button onclick="testCreateExpense()">Test Create Expense</button>
        <button onclick="testLoadData()">Test Load Data</button>
        <button onclick="clearTestData()">Clear Test Data</button>
    </div>

    <div class="debug-section">
        <h2>Debug Log</h2>
        <pre id="debugLog">Starting debug session...\n</pre>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDi9PeRLjWIfKmAVYC7vh1MJx9Ah8f79tw",
            authDomain: "split-the-tab.firebaseapp.com",
            projectId: "split-the-tab",
            storageBucket: "split-the-tab.firebasestorage.app",
            messagingSenderId: "65613542948",
            appId: "1:65613542948:web:7fd0b47606b2b619ef8ab1",
            measurementId: "G-E6SWPLWH01"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let currentUser = null;

        // Debug logging
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('debugLog');
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            logElement.textContent += logEntry;
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(`[DEBUG] ${logEntry.trim()}`);
        }

        function updateStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
        }

        // Firebase connection test
        async function testFirebaseConnection() {
            log('Testing Firebase connection...');
            try {
                // Test if Firebase is initialized
                if (firebase.apps.length > 0) {
                    updateStatus('firebaseStatus', 'Firebase is initialized âœ“', 'success');
                    log('Firebase initialization: SUCCESS');
                    return true;
                } else {
                    updateStatus('firebaseStatus', 'Firebase not initialized âœ—', 'error');
                    log('Firebase initialization: FAILED');
                    return false;
                }
            } catch (error) {
                updateStatus('firebaseStatus', `Firebase error: ${error.message}`, 'error');
                log(`Firebase error: ${error.message}`, 'error');
                return false;
            }
        }

        // Firestore test
        async function testFirestore() {
            log('Testing Firestore connection...');
            try {
                await db.collection('debug-test').add({
                    test: true,
                    timestamp: new Date()
                });
                updateStatus('firebaseStatus', 'Firestore connection successful âœ“', 'success');
                log('Firestore test: SUCCESS');
                return true;
            } catch (error) {
                updateStatus('firebaseStatus', `Firestore error: ${error.message}`, 'error');
                log(`Firestore error: ${error.message}`, 'error');
                return false;
            }
        }

        // Auth test
        async function testAuth() {
            log('Testing Firebase Auth...');
            try {
                const currentUser = auth.currentUser;
                if (currentUser) {
                    updateStatus('authStatus', `Authenticated as: ${currentUser.email || 'Anonymous'}`, 'success');
                    log(`Auth test: SUCCESS - ${currentUser.email || 'Anonymous'}`);
                } else {
                    updateStatus('authStatus', 'Not authenticated', 'warning');
                    log('Auth test: No user authenticated');
                }
                return true;
            } catch (error) {
                updateStatus('authStatus', `Auth error: ${error.message}`, 'error');
                log(`Auth error: ${error.message}`, 'error');
                return false;
            }
        }

        // Anonymous sign in
        async function signInAnonymously() {
            log('Signing in anonymously...');
            try {
                const userCredential = await auth.signInAnonymously();
                currentUser = userCredential.user;
                updateStatus('authStatus', 'Signed in anonymously âœ“', 'success');
                log('Anonymous sign in: SUCCESS');
                
                // Create user document
                await ensureUserDocument();
                return true;
            } catch (error) {
                updateStatus('authStatus', `Sign in failed: ${error.message}`, 'error');
                log(`Anonymous sign in error: ${error.message}`, 'error');
                return false;
            }
        }

        // Sign out
        async function signOut() {
            log('Signing out...');
            try {
                await auth.signOut();
                currentUser = null;
                updateStatus('authStatus', 'Signed out', 'info');
                log('Sign out: SUCCESS');
                return true;
            } catch (error) {
                updateStatus('authStatus', `Sign out failed: ${error.message}`, 'error');
                log(`Sign out error: ${error.message}`, 'error');
                return false;
            }
        }

        // Ensure user document exists
        async function ensureUserDocument() {
            if (!currentUser) return;
            
            try {
                const userDocRef = db.collection('users').doc(currentUser.uid);
                const userDoc = await userDocRef.get();
                
                if (!userDoc.exists) {
                    await userDocRef.set({
                        email: currentUser.email || 'anonymous',
                        groups: [],
                        createdAt: new Date(),
                        isDebugUser: true
                    });
                    log('User document created');
                }
            } catch (error) {
                log(`Error ensuring user document: ${error.message}`, 'error');
                throw error;
            }
        }

        // Test create group
        async function testCreateGroup() {
            log('Testing group creation...');
            if (!currentUser) {
                updateStatus('dbStatus', 'Please sign in first', 'warning');
                return;
            }

            try {
                await ensureUserDocument();

                const groupData = {
                    name: 'Debug Test Group',
                    description: 'This is a test group created by debug tool',
                    createdBy: currentUser.uid,
                    members: [currentUser.uid],
                    createdAt: new Date(),
                    isDebugGroup: true
                };

                const docRef = await db.collection('groups').add(groupData);
                
                // Add group to user's groups
                await db.collection('users').doc(currentUser.uid).set({
                    groups: firebase.firestore.FieldValue.arrayUnion(docRef.id)
                }, { merge: true });

                updateStatus('dbStatus', `Group created successfully! ID: ${docRef.id}`, 'success');
                log(`Group creation: SUCCESS - ID: ${docRef.id}`);
                return true;
            } catch (error) {
                updateStatus('dbStatus', `Group creation failed: ${error.message}`, 'error');
                log(`Group creation error: ${error.message}`, 'error');
                return false;
            }
        }

        // Test create expense
        async function testCreateExpense() {
            log('Testing expense creation...');
            if (!currentUser) {
                updateStatus('dbStatus', 'Please sign in first', 'warning');
                return;
            }

            try {
                // First get a group to add expense to
                const groupsSnapshot = await db.collection('groups')
                    .where('members', 'array-contains', currentUser.uid)
                    .limit(1)
                    .get();

                if (groupsSnapshot.empty) {
                    updateStatus('dbStatus', 'No groups found. Create a group first.', 'warning');
                    return;
                }

                const groupId = groupsSnapshot.docs[0].id;
                
                const expenseData = {
                    description: 'Debug Test Expense',
                    amount: 25.50,
                    paidBy: currentUser.uid,
                    groupId: groupId,
                    createdBy: currentUser.uid,
                    createdAt: new Date(),
                    members: [currentUser.uid],
                    isDebugExpense: true
                };

                const docRef = await db.collection('expenses').add(expenseData);
                updateStatus('dbStatus', `Expense created successfully! ID: ${docRef.id}`, 'success');
                log(`Expense creation: SUCCESS - ID: ${docRef.id}`);
                return true;
            } catch (error) {
                updateStatus('dbStatus', `Expense creation failed: ${error.message}`, 'error');
                log(`Expense creation error: ${error.message}`, 'error');
                return false;
            }
        }

        // Test load data
        async function testLoadData() {
            log('Testing data loading...');
            if (!currentUser) {
                updateStatus('dbStatus', 'Please sign in first', 'warning');
                return;
            }

            try {
                // Load groups
                const groupsSnapshot = await db.collection('groups')
                    .where('members', 'array-contains', currentUser.uid)
                    .get();
                
                const groups = groupsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // Load expenses
                const groupIds = groups.map(g => g.id);
                let expenses = [];
                
                if (groupIds.length > 0) {
                    const expensesSnapshot = await db.collection('expenses')
                        .where('groupId', 'in', groupIds)
                        .get();
                    
                    expenses = expensesSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    
                    // Sort expenses by creation date (newest first)
                    expenses.sort((a, b) => {
                        const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt);
                        const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt);
                        return dateB - dateA;
                    });
                }

                updateStatus('dbStatus', `Data loaded: ${groups.length} groups, ${expenses.length} expenses`, 'success');
                log(`Data loading: SUCCESS - ${groups.length} groups, ${expenses.length} expenses`);
                
                log(`Groups: ${JSON.stringify(groups, null, 2)}`);
                log(`Expenses: ${JSON.stringify(expenses, null, 2)}`);
                
                return true;
            } catch (error) {
                updateStatus('dbStatus', `Data loading failed: ${error.message}`, 'error');
                log(`Data loading error: ${error.message}`, 'error');
                return false;
            }
        }

        // Clear test data
        async function clearTestData() {
            log('Clearing test data...');
            if (!currentUser) {
                updateStatus('dbStatus', 'Please sign in first', 'warning');
                return;
            }

            try {
                // Delete debug groups
                const groupsSnapshot = await db.collection('groups')
                    .where('isDebugGroup', '==', true)
                    .get();
                
                const groupDeletePromises = groupsSnapshot.docs.map(doc => doc.ref.delete());
                await Promise.all(groupDeletePromises);

                // Delete debug expenses
                const expensesSnapshot = await db.collection('expenses')
                    .where('isDebugExpense', '==', true)
                    .get();
                
                const expenseDeletePromises = expensesSnapshot.docs.map(doc => doc.ref.delete());
                await Promise.all(expenseDeletePromises);

                // Delete debug test collections
                const debugSnapshot = await db.collection('debug-test').get();
                const debugDeletePromises = debugSnapshot.docs.map(doc => doc.ref.delete());
                await Promise.all(debugDeletePromises);

                updateStatus('dbStatus', 'Test data cleared successfully', 'success');
                log('Test data clearing: SUCCESS');
                return true;
            } catch (error) {
                updateStatus('dbStatus', `Clear test data failed: ${error.message}`, 'error');
                log(`Clear test data error: ${error.message}`, 'error');
                return false;
            }
        }

        function clearLog() {
            document.getElementById('debugLog').textContent = 'Debug log cleared...\n';
        }

        // Auth state listener
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                updateStatus('authStatus', `Authenticated as: ${user.email || 'Anonymous'}`, 'success');
                log(`Auth state changed: User logged in - ${user.email || 'Anonymous'}`);
            } else {
                currentUser = null;
                updateStatus('authStatus', 'Not authenticated', 'info');
                log('Auth state changed: User logged out');
            }
        });

        // Initialize
        window.addEventListener('load', () => {
            log('Debug page loaded');
            testFirebaseConnection();
        });
    </script>
</body>
</html> 